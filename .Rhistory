distn_needed <- sum(cumsum(onset_to_death(0:30))<=0.95) # make sure have at 95% of the cumulative distn
# calculate moving CFR on X day moving window -- need to modify
mov_window <- distn_needed
store_cfr <- NULL
for(tt in 1:nrow(data_1)){
store_cfr <- rbind(store_cfr,scale_cfr(data_1[max(0,tt-mov_window):tt,]))
}
store_cfr <- as_tibble(store_cfr); names(store_cfr) <- c("naive","cCFR")
# calculate moving CFR on X day moving window
# store_cfr_incidence <- NULL
# for(tt in 1:nrow(data_1)){
#   store_cfr_incidence <- rbind(store_cfr_incidence,scale_cfr_incidence(data_1,tt))
# }
# store_cfr_incidence <- as_tibble(store_cfr_incidence); names(store_cfr_incidence) <- c("naive","cCFR")
#
# Plot calculations
par(mfrow=c(3,1),mar=c(3,3,1,1),mgp=c(2,0.7,0))
# Plot delay
seq_xx <- seq(0,20,1)
ymax <- 1.1*max(onset_to_death(seq_xx))
plot(seq_xx,onset_to_death(seq_xx),pch=19,ylab="P(death on given day | death)",xlab="days after onset",ylim=c(0,ymax))
lines(seq_xx,onset_to_death(seq_xx),col="black",lwd=0.5)
# Plot data
par(mar=c(2,3,1,1))
ymax <- 1e6
plot(data_1$date,data_1$cases/scaled_reporting,ylab="incidence",type="l",log="y",xlab="",ylim=c(1,ymax))
lines(data_1$date,data_1$cases,col="black",lty=2)
lines(data_1$date,data_1$deaths,col="red")
text(labels="scaled cases (dashed)",x=min(data_1$date),y=0.5*ymax,adj=0,col="black")
text(labels="new cases (solid)",x=min(data_1$date),y=0.05*ymax,adj=0)
text(labels="new deaths",x=min(data_1$date),y=0.005*ymax,adj=0,col="red")
# Plot naive and corrected CFR
ymax <- 0.3
plot(data_1$date,store_cfr$naive,col="white",ylab=paste0("CFR"),xlab="",ylim=c(0,ymax))
lines(data_1$date,store_cfr$naive,col="blue",lty=2)
lines(data_1$date,data_1$naive_cfr,col="blue",lty=2)
lines(data_1$date,store_cfr$cCFR,col="blue")
text(labels="naive CFR (dashed)",x=min(data_1$date),y=0.9*ymax,adj=0,col="blue")
text(labels="corrected CFR estimate (solid)",x=min(data_1$date),y=0.8*ymax,adj=0,col="blue")
text(labels="naive CFR (raw data)",x=min(data_1$date),y=0.7*ymax,adj=0,col="black")
# Plot naive and corrected CFR - by incidence --  DEPRECATED
# ymax <- 1
# plot(data_1$date,store_cfr_incidence$cCFR,col="white",ylab=paste0(mov_window," day moving CFR"),xlab="",ylim=c(0,ymax))
# lines(data_1$date,store_cfr_incidence$cCFR,col="blue")
# text(labels="corrected CFR estimate (solid)",x=min(data_1$date),y=0.8*ymax,adj=0,col="blue")
#
dev.copy(png,paste("plots/cfr_estimate.png",sep=""),units="cm",width=10,height=15,res=150)
dev.off()
}
# Calculate scaling factor for CFR ----------------------------------------
# Calculate CFR scaling
scale_cfr <- function(data_1_in){
# DEBUG   data_1_in <- data_1[1:tt,]
cumulative_known_t <- 0 # cumulative cases with known outcome at time tt
# Sum over cases up to time tt
for(ii in 1:nrow(data_1_in)){
known_i <- 0 # number of cases with known outcome at time ii
for(jj in 0:(ii-1)){
known_jj <- (data_1_in[ii-jj,]$cases * onset_to_death(jj) )
known_i <- known_i + known_jj
}
known_i
cumulative_known_t <- known_all + known_i # Tally cumulative known
}
# naive CFR value
b_tt <- sum(data_1_in$deaths)/sum(data_1_in$cases)
# nCFR estimator
p_tt <- b_tt * sum(data_1_in$cases)/cumulative_known_t
c(b_tt,p_tt)
}
# Calculate CFR using incidence data
scale_cfr_incidence <- function(data_1_in,tt){
# DEBUG   data_1_in <- data_1[1:tt,]
cumulative_known_t <- 0 # cumulative cases with known outcome at time tt
# Focus on data point tt
ii <- tt
known_i <- 0 # number of cases with known outcome at time ii
for(jj in 0:(ii-1)){
known_jj <- (data_1_in[ii-jj,]$cases * onset_to_death(jj) )
known_i <- known_i + known_jj
}
known_i
# naive CFR value
b_tt <- sum(data_1[tt,]$deaths)/sum(data_1[tt,]$cases)
# nCFR estimator
p_tt <- data_1[tt,]$deaths/known_i
c(b_tt,p_tt)
}
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 67
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
1/0.1
1/0.16
1/0.015
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
4000/440
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 5
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
library(tidyverse)
# - - -
# Set user-specific directory path and load datasets
if(Sys.info()["user"]=="adamkuchars" | Sys.info()["user"]=="adamkucharski") {
setwd("~/Documents/GitHub/CFR_calculation/")
}
# Load data and functions ---------------------------------------------------------------
source("R/functions.R")
# Load case & death timeseries
all_dat <- read_csv("data/case_death_data.csv")
all_dat <- all_dat %>% mutate(naive_cfr = cumulative_deaths/cumulative_cases) # Add naive cfr
# Define onset-to-death distribution
# 9.1 day onset-to-hospitalisation in Li et al NEJM paper
scaled_reporting <- 65
meanG <- 9.1 + 3
scaleG <- 0.5
onset_to_death <- function(x){ dgamma(x, meanG/scaleG, scale = scaleG) }
# Plot data ---------------------------------------------------------------
plot_cfr_basic()
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(echo = FALSE)
